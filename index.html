<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Truck: Real-Time Trading</title>
    <style>
        :root {
            --bg-color: #FDF1D6;       
            --box-bg: #FCEFC7;         
            --teal-btn: #00BFA5;       
            --teal-hover: #008F7A;
            --blue-border: #2D74DA;    
            --overlay-bg: rgba(0,0,0,0.6);
            --text-dark: #333333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-dark);
        }

        .container {
            width: 100%;
            max-width: 950px;
            text-align: center;
        }

        .hidden { display: none !important; }
        
        /* --- GAME HEADER --- */
        .prod-bar {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            border: 2px solid var(--blue-border);
            border-radius: 10px;
            padding: 10px 40px;
            background: rgba(255,255,255,0.6);
            font-size: 18px;
            font-weight: bold;
            color: var(--blue-border);
            margin-bottom: 20px;
        }

        /* --- MAIN GAME GRID --- */
        .game-layout {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
            align-items: start;
        }

        /* LEFT: PREP TIME */
        .prep-box {
            background-color: var(--box-bg);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ecdca8;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            background: white;
            border: 2px solid var(--teal-btn);
            border-radius: 8px;
            overflow: hidden;
            height: 50px;
        }

        .control-btn {
            background: var(--teal-btn);
            color: white;
            border: none;
            width: 45px;
            height: 100%;
            font-size: 24px;
            cursor: pointer;
        }

        /* RIGHT: OUTPUT & TRADING */
        .output-box {
            background: white;
            border: 2px solid var(--blue-border);
            border-radius: 12px;
            padding: 20px;
        }

        .inventory-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .trade-diff { font-size: 14px; color: #666; font-weight: normal; margin-left: 5px;}
        .diff-pos { color: green; font-weight: bold;}
        .diff-neg { color: red; font-weight: bold;}

        .action-btn {
            width: 100%;
            background-color: var(--teal-btn);
            color: white;
            border: none;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 0 #008f7a;
            margin-top: 10px;
        }
        .action-btn:hover { transform: translateY(2px); box-shadow: 0 2px 0 #008f7a; }
        .btn-dark { background-color: #006064; box-shadow: 0 4px 0 #00363a; }

        /* --- TRADE MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        /* Ensure incoming offer sits ON TOP of your proposal if both happen */
        #modal-incoming { z-index: 1100; }

        .trade-card {
            background: white;
            width: 550px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .trade-header {
            padding: 15px;
            text-align: center;
            color: var(--blue-border);
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
        }

        .trade-body {
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .trade-item { text-align: center; width: 140px; }
        .food-icon-lg { font-size: 50px; display: block; margin-bottom: 10px; }

        .spinner-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid var(--teal-btn);
            border-radius: 8px;
            overflow: hidden;
        }
        .spin-btn { background: var(--teal-btn); color: white; border: none; width: 100%; cursor: pointer; }
        .spin-val { padding: 10px; font-size: 20px; font-weight: bold; width: 100%; border: none; text-align: center; }

        .trade-actions { display: flex; }
        .modal-btn { flex: 1; padding: 20px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; color: white; }
        .btn-accept { background: var(--teal-btn); }
        .btn-decline { background: #999; }

        .gain-loss-display {
            text-align: center;
            padding: 10px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            font-size: 16px;
            color: #555;
        }

        /* STATUS BAR */
        .status-bar {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            background: #2C3E50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            font-family: monospace;
            box-sizing: border-box;
            font-size: 18px;
        }
    </style>
</head>
<body>

<div id="screen-intro" class="container">
    <div style="background:white; padding:40px; border-radius:20px; text-align:left; max-width:600px; margin:0 auto;">
        <h1 style="text-align: center;">Food Truck: Trade Edition</h1>
        <p><strong>Goal:</strong> Maximize Combos (1 Burger + 1 Fry).</p>
        <p><strong>How to win:</strong></p>
        <ol>
            <li>Adjust your production sliders.</li>
            <li>Look for trade opportunities.</li>
            <li><strong>Watch the "Combos Gained" number!</strong> Only accept trades that give you a positive (+) gain.</li>
        </ol>
        <div style="text-align: center; margin-top: 30px;">
            <button class="action-btn" onclick="startGame()">Start Simulation</button>
        </div>
    </div>
</div>

<div id="screen-game" class="container hidden">
    
    <div class="prod-bar">
        <span>Your Rate: <span id="rate-f">8</span> Fries OR <span id="rate-b">4</span> Burgers / min</span>
    </div>

    <div class="game-layout">
        <div class="prep-box">
            <h3 style="margin-top:0; color:#2D74DA;">Prep Time</h3>
            <div class="input-group">
                <button class="control-btn" onclick="adjustTime('burgers', -1)">-</button>
                <div style="font-weight:bold; font-size:20px;"><span id="time-b">15</span> min</div>
                <button class="control-btn" onclick="adjustTime('burgers', 1)">+</button>
            </div>
            <div class="input-group">
                <button class="control-btn" onclick="adjustTime('fries', -1)">-</button>
                <div style="font-weight:bold; font-size:20px;"><span id="time-f">15</span> min</div>
                <button class="control-btn" onclick="adjustTime('fries', 1)">+</button>
            </div>
            <p style="color:#666;">Connected to: <strong id="partner-name">Searching...</strong></p>
        </div>

        <div class="output-box">
            <h3 style="margin-top:0; color:#2D74DA;">Current Inventory</h3>
            
            <div class="inventory-row">
                <span>üçî Burgers</span>
                <span>
                    <span id="inv-b">60</span> 
                    <span id="diff-b" class="trade-diff"></span>
                </span>
            </div>
            <div class="inventory-row">
                <span>üçü Fries</span>
                <span>
                    <span id="inv-f">120</span>
                    <span id="diff-f" class="trade-diff"></span>
                </span>
            </div>

            <button class="action-btn btn-dark" onclick="openProposeModal()">Propose Trade</button>
            <button class="action-btn" onclick="submitRound()">Bring <span id="combo-count">60</span> Combos</button>
        </div>
    </div>
</div>

<div id="modal-propose" class="modal-overlay hidden">
    <div class="trade-card">
        <div class="trade-header">
            <span>üöö You Propose</span>
        </div>
        <div class="trade-body">
            <div class="trade-item">
                <div class="food-icon-lg">üì§</div>
                <div>You Give</div>
                <div class="spinner-box">
                    <button class="spin-btn" onclick="adjustOffer('give', 1)">‚ñ≤</button>
                    <input id="offer-give-val" class="spin-val" value="5" readonly>
                    <button class="spin-btn" onclick="adjustOffer('give', -1)">‚ñº</button>
                </div>
                <select id="offer-give-type" onchange="calculateGain()" style="width:100%; margin-top:5px; padding:5px;">
                    <option value="burgers">Burgers</option>
                    <option value="fries">Fries</option>
                </select>
            </div>

            <div style="font-weight:bold; color:#aaa;">FOR</div>

            <div class="trade-item">
                <div class="food-icon-lg">üì•</div>
                <div>You Get</div>
                <div class="spinner-box">
                    <button class="spin-btn" onclick="adjustOffer('get', 1)">‚ñ≤</button>
                    <input id="offer-get-val" class="spin-val" value="5" readonly>
                    <button class="spin-btn" onclick="adjustOffer('get', -1)">‚ñº</button>
                </div>
                <select id="offer-get-type" onchange="calculateGain()" style="width:100%; margin-top:5px; padding:5px;">
                    <option value="fries">Fries</option>
                    <option value="burgers">Burgers</option>
                </select>
            </div>
        </div>

        <div class="gain-loss-display">
            Combos Gained From This Trade: <strong id="propose-gain-val">0</strong>
        </div>

        <div class="trade-actions">
            <button class="modal-btn btn-accept" onclick="sendProposal()">Send Proposal</button>
            <button class="modal-btn btn-decline" onclick="closeModal('modal-propose')">Cancel</button>
        </div>
    </div>
</div>

<div id="modal-incoming" class="modal-overlay hidden">
    <div class="trade-card" style="border: 4px solid #F5A623;">
        <div class="trade-header" style="background:#F5A623; color:white;">
            <span>üîî New Offer from Partner!</span>
        </div>
        <div class="trade-body">
            <div class="trade-item">
                <div class="food-icon-lg" id="inc-give-icon">üçü</div>
                <div>Neighbor Gives</div>
                <h1 id="inc-give-amt" style="margin:5px 0;">8</h1>
                <div id="inc-give-name">Fries</div>
            </div>
            
            <div style="font-weight:bold; color:#aaa;">FOR</div>

            <div class="trade-item">
                <div class="food-icon-lg" id="inc-get-icon">üçî</div>
                <div>You Give</div>
                <h1 id="inc-get-amt" style="margin:5px 0;">4</h1>
                <div id="inc-get-name">Burgers</div>
            </div>
        </div>

        <div class="gain-loss-display">
            Combos Gained From This Trade: <strong id="inc-gain-val">0</strong>
        </div>

        <div class="trade-actions">
            <button class="modal-btn btn-accept" onclick="acceptIncoming()">Accept</button>
            <button class="modal-btn btn-decline" onclick="declineIncoming()">Decline</button>
        </div>
    </div>
</div>

<div id="modal-result" class="modal-overlay hidden">
    <div class="trade-card" style="padding: 30px;">
        <h2 style="color:var(--teal-btn);">Morning Shift Complete</h2>
        <h1><span id="res-score">0</span> Combos Sold</h1>
        <p id="res-msg" style="color:#666;"></p>
        <button class="action-btn" onclick="location.reload()">Next Round</button>
    </div>
</div>

<div class="status-bar">
    <div>Simulation Active</div>
    <div id="timer">02:00</div>
</div>

<script>
    // --- GAME VARIABLES ---
    let timeB = 15, timeF = 15;
    let rateB = 4, rateF = 8;
    
    // Inventory State
    let productionB = 0, productionF = 0;
    let netTradeB = 0, netTradeF = 0;

    // Bot Variables
    let botInterval;
    let botRateB = 8, botRateF = 2; 
    let activeBotOffer = null;

    // --- INITIALIZATION ---
    function startGame() {
        document.getElementById('screen-intro').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');
        
        // Randomize Rates
        rateB = (Math.floor(Math.random() * 3) + 1) * 2; // e.g. 2, 4, 6
        rateF = (Math.floor(Math.random() * 3) + 3) * 2; // e.g. 6, 8, 10
        // Bot is opposite
        botRateB = rateF; 
        botRateF = rateB;

        document.getElementById('rate-b').innerText = rateB;
        document.getElementById('rate-f').innerText = rateF;
        document.getElementById('partner-name').innerText = "Truck_" + Math.floor(Math.random()*1000);

        updateEngine();
        
        // Start Bot Logic (Proposals happen every 12-20 seconds)
        botInterval = setInterval(triggerBotProposal, 12000 + Math.random() * 8000);
        
        startTimer();
    }

    // --- CORE ENGINE ---
    function adjustTime(type, val) {
        if(type === 'burgers') {
            if(val > 0 && timeF > 0) { timeB++; timeF--; }
            if(val < 0 && timeB > 0) { timeB--; timeF++; }
        } else {
            if(val > 0 && timeB > 0) { timeF++; timeB--; }
            if(val < 0 && timeF > 0) { timeF--; timeB++; }
        }
        updateEngine();
    }

    function updateEngine() {
        productionB = timeB * rateB;
        productionF = timeF * rateF;
        
        let finalB = Math.max(0, productionB + netTradeB);
        let finalF = Math.max(0, productionF + netTradeF);

        document.getElementById('time-b').innerText = timeB;
        document.getElementById('time-f').innerText = timeF;
        document.getElementById('inv-b').innerText = finalB;
        document.getElementById('inv-f').innerText = finalF;

        // Trade diff indicators
        updateDiff('diff-b', netTradeB);
        updateDiff('diff-f', netTradeF);

        document.getElementById('combo-count').innerText = Math.min(finalB, finalF);
    }

    function updateDiff(id, val) {
        let el = document.getElementById(id);
        if(val === 0) {
            el.innerText = "";
        } else {
            el.innerText = val > 0 ? `(+${val})` : `(${val})`;
            el.className = val > 0 ? "trade-diff diff-pos" : "trade-diff diff-neg";
        }
    }

    // --- PROPOSAL LOGIC (YOU SENDING) ---
    function openProposeModal() {
        document.getElementById('modal-propose').classList.remove('hidden');
        calculateGain(); // Init calculation
    }

    function adjustOffer(side, delta) {
        let el = document.getElementById('offer-' + side + '-val');
        let val = parseInt(el.value) + delta;
        if(val < 1) val = 1;
        el.value = val;
        calculateGain(); // Recalculate on change
    }

    // --- THE "GAIN/LOSS" CALCULATOR ---
    function calculateGain() {
        let giveType = document.getElementById('offer-give-type').value;
        let getType = document.getElementById('offer-get-type').value;
        let giveAmt = parseInt(document.getElementById('offer-give-val').value);
        let getAmt = parseInt(document.getElementById('offer-get-val').value);

        // Current Inventory
        let currB = productionB + netTradeB;
        let currF = productionF + netTradeF;
        let currCombos = Math.min(currB, currF);

        // Projected Inventory
        let newB = currB;
        let newF = currF;

        if(giveType === 'burgers') newB -= giveAmt; else newF -= giveAmt;
        if(getType === 'burgers') newB += getAmt; else newF += getAmt;

        let newCombos = Math.min(newB, newF);
        let diff = newCombos - currCombos;

        let el = document.getElementById('propose-gain-val');
        el.innerText = diff > 0 ? "+" + diff : diff;
        el.style.color = diff >= 0 ? "green" : "red";
    }

    function sendProposal() {
        // Simple "Sensible" Bot Acceptance Logic
        let giveType = document.getElementById('offer-give-type').value;
        let giveAmt = parseInt(document.getElementById('offer-give-val').value);
        let getAmt = parseInt(document.getElementById('offer-get-val').value);
        
        // 1. Check if user has items
        let userHas = (giveType === 'burgers') ? (productionB + netTradeB) : (productionF + netTradeF);
        if(userHas < giveAmt) {
            alert("Insufficient Inventory!");
            return;
        }

        // 2. Bot Decides (Is this a good deal for the Bot?)
        // Bot accepts if you give what it needs (it needs what it is bad at)
        // Bot is bad at 'fries' if botRateF < botRateB
        let botNeeds = (botRateF < botRateB) ? 'fries' : 'burgers';
        let botAccepts = false;

        if(giveType === botNeeds) {
            // Price Check: Bot won't pay crazy amounts
            // Accept if GetAmt/GiveAmt ratio is < 2
            if(getAmt / giveAmt <= 2.0) botAccepts = true;
        }

        // Fake "Processing" delay
        closeModal('modal-propose');
        setTimeout(() => {
            if(botAccepts) {
                alert("Partner ACCEPTED your deal!");
                applyTrade(-giveAmt, getAmt, giveType, document.getElementById('offer-get-type').value);
            } else {
                alert("Partner DECLINED. (Tip: Offer them what they are bad at producing)");
            }
        }, 500);
    }

    // --- INCOMING OFFERS (BOT SENDING) ---
    function triggerBotProposal() {
        if(!document.getElementById('modal-result').classList.contains('hidden')) return;

        // Bot generates a "Sensible" offer
        // Bot gives what it is GOOD at, asks for what it is BAD at.
        let botGiveType = (botRateB > botRateF) ? 'Burgers' : 'Fries';
        let botAskType = (botGiveType === 'Burgers') ? 'Fries' : 'Burgers';

        // Ratio: Bot gives 3 for 2, or 5 for 3. (Roughly 1.5 ratio)
        let amtGive = Math.floor(Math.random() * 3) + 4; // 4-6
        let amtAsk = Math.floor(Math.random() * 2) + 2;  // 2-3

        activeBotOffer = { giveType: botGiveType, giveAmt: amtGive, askType: botAskType, askAmt: amtAsk };

        // Update UI
        document.getElementById('inc-give-icon').innerText = (botGiveType === 'Burgers') ? 'üçî' : 'üçü';
        document.getElementById('inc-give-name').innerText = botGiveType;
        document.getElementById('inc-give-amt').innerText = amtGive;

        document.getElementById('inc-get-icon').innerText = (botAskType === 'Burgers') ? 'üçî' : 'üçü';
        document.getElementById('inc-get-name').innerText = botAskType;
        document.getElementById('inc-get-amt').innerText = amtAsk;

        calculateIncomingGain(); // Update the gain/loss number for this specific offer
        document.getElementById('modal-incoming').classList.remove('hidden');
    }

    function calculateIncomingGain() {
        if(!activeBotOffer) return;
        
        let currB = productionB + netTradeB;
        let currF = productionF + netTradeF;
        let currCombos = Math.min(currB, currF);

        let newB = currB;
        let newF = currF;

        // You Receive (GiveAmt) of GiveType
        if(activeBotOffer.giveType === 'Burgers') newB += activeBotOffer.giveAmt; 
        else newF += activeBotOffer.giveAmt;

        // You Pay (AskAmt) of AskType
        if(activeBotOffer.askType === 'Burgers') newB -= activeBotOffer.askAmt; 
        else newF -= activeBotOffer.askAmt;

        let newCombos = Math.min(newB, newF);
        let diff = newCombos - currCombos;

        let el = document.getElementById('inc-gain-val');
        el.innerText = diff > 0 ? "+" + diff : diff;
        el.style.color = diff >= 0 ? "green" : "red";
    }

    function acceptIncoming() {
        let payType = activeBotOffer.askType;
        let payAmt = activeBotOffer.askAmt;

        // Check Funds
        let userHas = (payType === 'Burgers') ? (productionB + netTradeB) : (productionF + netTradeF);
        if(userHas < payAmt) {
            alert("You don't have enough inventory to accept!");
            return;
        }

        applyTrade(activeBotOffer.giveAmt, -activeBotOffer.askAmt, activeBotOffer.giveType, activeBotOffer.askType);
        closeModal('modal-incoming');
    }

    function declineIncoming() {
        closeModal('modal-incoming');
    }

    function applyTrade(delta1, delta2, type1, type2) {
        // Delta1 is amount of Type1 (positive or negative)
        // Delta2 is amount of Type2 (positive or negative)
        if(type1.toLowerCase() === 'burgers') netTradeB += delta1; else netTradeF += delta1;
        if(type2.toLowerCase() === 'burgers') netTradeB += delta2; else netTradeF += delta2;
        updateEngine();
    }

    // --- UTILS ---
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    
    function submitRound() {
        clearInterval(botInterval);
        document.getElementById('res-score').innerText = document.getElementById('combo-count').innerText;
        document.getElementById('modal-result').classList.remove('hidden');
    }

    function startTimer() {
        let sec = 120;
        let timerInt = setInterval(() => {
            sec--;
            let m = Math.floor(sec/60);
            let s = sec%60;
            document.getElementById('timer').innerText = `0${m}:${s<10?'0'+s:s}`;
            if(sec <= 0) { clearInterval(timerInt); submitRound(); }
        }, 1000);
    }
</script>

</body>
</html>
