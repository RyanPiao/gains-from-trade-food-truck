<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Truck: Trade Simulation</title>
    <style>
        :root {
            --bg-color: #FDF1D6;       
            --box-bg: #FCEFC7;         
            --teal-btn: #00BFA5;       
            --teal-hover: #008F7A;
            --blue-border: #2D74DA;    
            --orange: #F5A623;
            --text-dark: #333333;
            --overlay-bg: rgba(0,0,0,0.6);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-dark);
        }

        .container {
            width: 100%;
            max-width: 950px;
            text-align: center;
        }

        .hidden { display: none !important; }
        
        /* --- INTRO SCREEN --- */
        .intro-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
            text-align: left;
        }

        /* --- GAME HEADER --- */
        .prod-bar {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            border: 2px solid var(--blue-border);
            border-radius: 10px;
            padding: 10px 40px;
            background: rgba(255,255,255,0.6);
            font-size: 18px;
            font-weight: bold;
            color: var(--blue-border);
            margin-bottom: 20px;
        }

        /* --- MAIN GAME GRID --- */
        .game-layout {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
            align-items: start;
        }

        /* LEFT: PREP TIME */
        .prep-box {
            background-color: var(--box-bg);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ecdca8;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            background: white;
            border: 2px solid var(--teal-btn);
            border-radius: 8px;
            overflow: hidden;
            height: 50px;
        }

        .control-btn {
            background: var(--teal-btn);
            color: white;
            border: none;
            width: 45px;
            height: 100%;
            font-size: 24px;
            cursor: pointer;
        }
        .control-btn:hover { background: var(--teal-hover); }

        /* RIGHT: OUTPUT & TRADING */
        .output-box {
            background: white;
            border: 2px solid var(--blue-border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }

        .inventory-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .inventory-row:last-child { border-bottom: none; }

        .trade-diff { font-size: 14px; color: #666; font-weight: normal; }
        .diff-pos { color: green; }
        .diff-neg { color: red; }

        /* BUTTONS */
        .btn-row {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .action-btn {
            flex: 1;
            background-color: var(--teal-btn);
            color: white;
            border: none;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 0 #008f7a;
        }
        .action-btn:hover { transform: translateY(2px); box-shadow: 0 2px 0 #008f7a; }
        .btn-dark { background-color: #006064; box-shadow: 0 4px 0 #00363a; }
        .btn-dark:hover { box-shadow: 0 2px 0 #00363a; }

        /* --- TRADE MODAL (MobLab Style) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .trade-card {
            background: white;
            width: 550px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .trade-header {
            padding: 15px;
            text-align: center;
            color: var(--blue-border);
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trade-body {
            padding: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .trade-item {
            text-align: center;
            width: 140px;
        }
        
        .food-icon-lg { font-size: 50px; display: block; margin-bottom: 10px; }

        .spinner-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid var(--teal-btn);
            border-radius: 8px;
            overflow: hidden;
        }
        .spin-btn {
            background: var(--teal-btn);
            color: white;
            border: none;
            width: 100%;
            padding: 5px;
            cursor: pointer;
        }
        .spin-val {
            padding: 10px;
            font-size: 20px;
            font-weight: bold;
            width: 100%;
            border: none;
            text-align: center;
        }

        .trade-actions {
            display: flex;
        }
        .modal-btn {
            flex: 1;
            padding: 20px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn-accept { background: var(--teal-btn); }
        .btn-accept:hover { background: var(--teal-hover); }
        .btn-decline { background: #999; }
        .btn-decline:hover { background: #777; }

        /* STATUS BAR */
        .status-bar {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            background: #2C3E50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            font-family: monospace;
            box-sizing: border-box;
            font-size: 18px;
        }

    </style>
</head>
<body>

<div id="screen-intro" class="container">
    <div class="intro-card">
        <h1 style="text-align: center;">Food Truck: Trade Edition</h1>
        <p>In this version, you are not alone! You have a neighbor.</p>
        <ul>
            <li><strong>Production:</strong> Allocate your 30 minutes.</li>
            <li><strong>Trade:</strong> You can exchange Burgers for Fries with your neighbor.</li>
            <li><strong>Proposals:</strong> Your neighbor might send you offers, or you can send them offers.</li>
        </ul>
        <div style="text-align: center; margin-top: 30px;">
            <button class="action-btn" onclick="startGame()">Find a Partner & Start</button>
        </div>
    </div>
</div>

<div id="screen-game" class="container hidden">
    
    <div class="prod-bar">
        <span>Your Rate: <span id="rate-f">8</span> Fries OR <span id="rate-b">4</span> Burgers / min</span>
    </div>

    <div class="game-layout">
        <div class="prep-box">
            <h3 style="color:var(--blue-border); margin-top:0;">Prep Time</h3>
            
            <div class="input-group">
                <button class="control-btn" onclick="adjustTime('burgers', -1)">-</button>
                <div style="font-weight:bold; font-size:20px;"><span id="time-b">15</span> min</div>
                <button class="control-btn" onclick="adjustTime('burgers', 1)">+</button>
            </div>
            
            <div class="input-group">
                <button class="control-btn" onclick="adjustTime('fries', -1)">-</button>
                <div style="font-weight:bold; font-size:20px;"><span id="time-f">15</span> min</div>
                <button class="control-btn" onclick="adjustTime('fries', 1)">+</button>
            </div>
            
            <div style="text-align:center; color:#666;">
                <small>Partner: <span id="partner-name">Searching...</span></small>
            </div>
        </div>

        <div class="output-box">
            <h3 style="color:var(--blue-border); margin-top:0;">Inventory (Production + Trade)</h3>
            
            <div class="inventory-row">
                <span>üçî Burgers</span>
                <span>
                    <span id="inv-b">60</span> 
                    <span id="diff-b" class="trade-diff"></span>
                </span>
            </div>
            <div class="inventory-row">
                <span>üçü Fries</span>
                <span>
                    <span id="inv-f">120</span>
                    <span id="diff-f" class="trade-diff"></span>
                </span>
            </div>

            <div class="btn-row">
                <button class="action-btn btn-dark" onclick="openProposeModal()">Propose Trade</button>
                <button class="action-btn" onclick="submitRound()">Bring <span id="combo-count">60</span> Combos</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-propose" class="modal-overlay hidden">
    <div class="trade-card">
        <div class="trade-header">
            <span>üöö You</span>
            <span>Propose a Trade</span>
            <span>Neighbor üöö</span>
        </div>
        <div class="trade-body">
            <div class="trade-item">
                <div class="food-icon-lg">üçî</div>
                <div>You Give</div>
                <div class="spinner-box">
                    <button class="spin-btn" onclick="adjustOffer('give', 1)">‚ñ≤</button>
                    <input id="offer-give-val" class="spin-val" value="5" readonly>
                    <button class="spin-btn" onclick="adjustOffer('give', -1)">‚ñº</button>
                </div>
                <select id="offer-give-type" style="margin-top:5px; padding:5px; width:100%;">
                    <option value="burgers">Burgers</option>
                    <option value="fries">Fries</option>
                </select>
            </div>

            <div style="font-weight:bold; color:#aaa;">FOR</div>

            <div class="trade-item">
                <div class="food-icon-lg">üçü</div>
                <div>You Get</div>
                <div class="spinner-box">
                    <button class="spin-btn" onclick="adjustOffer('get', 1)">‚ñ≤</button>
                    <input id="offer-get-val" class="spin-val" value="5" readonly>
                    <button class="spin-btn" onclick="adjustOffer('get', -1)">‚ñº</button>
                </div>
                <select id="offer-get-type" style="margin-top:5px; padding:5px; width:100%;">
                    <option value="fries">Fries</option>
                    <option value="burgers">Burgers</option>
                </select>
            </div>
        </div>
        <div class="trade-actions">
            <button class="modal-btn btn-accept" onclick="sendProposal()">Send Proposal</button>
            <button class="modal-btn btn-decline" onclick="closeModal('modal-propose')">Cancel</button>
        </div>
    </div>
</div>

<div id="modal-incoming" class="modal-overlay hidden">
    <div class="trade-card" style="border: 4px solid var(--teal-btn);">
        <div class="trade-header" style="background:var(--teal-btn); color:white;">
            <span>üîî New Proposal!</span>
        </div>
        <div class="trade-body">
            <div class="trade-item">
                <div class="food-icon-lg" id="inc-give-icon">üçü</div>
                <div>Neighbor Gives</div>
                <h1 id="inc-give-amt">8</h1>
                <div id="inc-give-name">Fries</div>
            </div>
            
            <div style="font-weight:bold; color:#aaa;">FOR</div>

            <div class="trade-item">
                <div class="food-icon-lg" id="inc-get-icon">üçî</div>
                <div>You Give</div>
                <h1 id="inc-get-amt">4</h1>
                <div id="inc-get-name">Burgers</div>
            </div>
        </div>
        <div class="trade-actions">
            <button class="modal-btn btn-accept" onclick="acceptIncoming()">Accept</button>
            <button class="modal-btn btn-decline" onclick="declineIncoming()">Decline</button>
        </div>
    </div>
</div>

<div id="modal-result" class="modal-overlay hidden">
    <div class="trade-card" style="padding: 20px;">
        <h2 style="color:var(--teal-btn);">Round Complete</h2>
        <h1><span id="res-score">0</span> Combos</h1>
        <p id="res-msg"></p>
        <button class="action-btn" onclick="location.reload()">Next Round</button>
    </div>
</div>

<div class="status-bar">
    <div>Simulation Active</div>
    <div id="timer">02:00</div>
</div>

<script>
    // --- GAME STATE ---
    let timeB = 15, timeF = 15;
    let rateB = 4, rateF = 8;
    let productionB = 0, productionF = 0;
    
    // Trade Tracking
    let netTradeB = 0; // Positive = gained, Negative = lost
    let netTradeF = 0;

    // Bot State
    let botRateB = 8, botRateF = 2; // Bot is opposite of player
    let botName = "Truck_" + Math.floor(Math.random() * 900 + 100);
    let botInterval;
    let currentBotOffer = null; // Store active offer data

    // --- INIT ---
    function startGame() {
        document.getElementById('screen-intro').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');
        document.getElementById('partner-name').innerText = "Connected to: " + botName;
        
        // Randomize Player Rates
        rateB = (Math.floor(Math.random() * 3) + 1) * 2; // 2, 4, 6
        rateF = (Math.floor(Math.random() * 3) + 3) * 2; // 6, 8, 10
        // Ensure Bot is different (Opposite Comparative Advantage)
        botRateB = rateF; 
        botRateF = rateB;

        document.getElementById('rate-b').innerText = rateB;
        document.getElementById('rate-f').innerText = rateF;
        
        updateEngine();
        
        // Start Bot Logic: Bot proposes a trade every 15-25 seconds
        botInterval = setInterval(triggerBotProposal, 15000 + Math.random() * 10000);
        
        // Start Timer
        startTimer();
    }

    // --- CORE ENGINE ---
    function adjustTime(type, val) {
        if(type === 'burgers') {
            if(val > 0 && timeF > 0) { timeB++; timeF--; }
            if(val < 0 && timeB > 0) { timeB--; timeF++; }
        } else {
            if(val > 0 && timeB > 0) { timeF++; timeB--; }
            if(val < 0 && timeF > 0) { timeF--; timeB++; }
        }
        updateEngine();
    }

    function updateEngine() {
        // 1. Calculate Production
        productionB = timeB * rateB;
        productionF = timeF * rateF;
        
        // 2. Update UI Times
        document.getElementById('time-b').innerText = timeB;
        document.getElementById('time-f').innerText = timeF;

        // 3. Calculate Final Inventory (Prod + Net Trade)
        let finalB = productionB + netTradeB;
        let finalF = productionF + netTradeF;

        // Prevent Negative Inventory (Undo trade logic if needed, but for simplicity we clamp to 0 visually)
        if(finalB < 0) finalB = 0;
        if(finalF < 0) finalF = 0;

        document.getElementById('inv-b').innerText = finalB;
        document.getElementById('inv-f').innerText = finalF;

        // 4. Show Trade Diff
        let diffBEl = document.getElementById('diff-b');
        let diffFEl = document.getElementById('diff-f');
        
        diffBEl.innerText = netTradeB !== 0 ? (netTradeB > 0 ? `(+${netTradeB})` : `(${netTradeB})`) : "";
        diffBEl.className = netTradeB >= 0 ? "trade-diff diff-pos" : "trade-diff diff-neg";
        
        diffFEl.innerText = netTradeF !== 0 ? (netTradeF > 0 ? `(+${netTradeF})` : `(${netTradeF})`) : "";
        diffFEl.className = netTradeF >= 0 ? "trade-diff diff-pos" : "trade-diff diff-neg";

        // 5. Combos
        document.getElementById('combo-count').innerText = Math.min(finalB, finalF);
    }

    // --- PLAYER PROPOSALS ---
    function openProposeModal() {
        document.getElementById('modal-propose').classList.remove('hidden');
    }

    function adjustOffer(side, delta) {
        let el = document.getElementById('offer-' + side + '-val');
        let val = parseInt(el.value) + delta;
        if(val < 1) val = 1;
        el.value = val;
    }

    function sendProposal() {
        // Simply Accept/Decline Logic for Bot
        // Bot accepts if the user offers a "Good Deal"
        // A Good Deal is defined loosely as: Giving the Bot what the Bot is bad at producing.
        
        let giveType = document.getElementById('offer-give-type').value; // User Gives
        let getType = document.getElementById('offer-get-type').value;   // User Gets
        let giveAmt = parseInt(document.getElementById('offer-give-val').value);
        let getAmt = parseInt(document.getElementById('offer-get-val').value);

        // Bot Logic:
        // Bot likes Burgers if Bot is bad at Burgers.
        // Bot is bad at Burgers if botRateB < botRateF.
        let botWants = (botRateB < botRateF) ? 'burgers' : 'fries';
        
        let accepted = false;
        
        // 1. Does user give what bot wants?
        if(giveType === botWants) {
            // 2. Is the price okay? (Bot shouldn't pay more than its own opportunity cost)
            // Simple heuristic: Bot accepts if ratio is reasonable (e.g., < 2:1)
            if (getAmt / giveAmt < 2.5) accepted = true;
        }

        // Check if Player actually has the goods
        let playerHas = (giveType === 'burgers') ? (productionB + netTradeB) : (productionF + netTradeF);
        if(playerHas < giveAmt) {
            alert("You don't have enough " + giveType + " to offer!");
            return;
        }

        closeModal('modal-propose');

        if(accepted) {
            alert(botName + " ACCEPTED your offer!");
            if(giveType === 'burgers') { netTradeB -= giveAmt; netTradeF += getAmt; }
            else { netTradeF -= giveAmt; netTradeB += getAmt; }
            updateEngine();
        } else {
            alert(botName + " DECLINED. They don't want that deal.");
        }
    }

    // --- BOT PROPOSALS ---
    function triggerBotProposal() {
        if(!document.getElementById('modal-propose').classList.contains('hidden')) return; // Don't interrupt user
        if(!document.getElementById('modal-result').classList.contains('hidden')) return;

        // Bot generates offer based on its surplus
        // Bot gives what it is good at.
        let botGoodAt = (botRateB > botRateF) ? 'Burgers' : 'Fries';
        let botBadAt = (botGoodAt === 'Burgers') ? 'Fries' : 'Burgers';

        // Offer: Bot gives 5 Good for 3 Bad (Just an example ratio)
        let offerGive = Math.floor(Math.random() * 3) + 4; // 4 to 6
        let offerGet = Math.floor(Math.random() * 3) + 2;  // 2 to 4

        currentBotOffer = {
            giveName: botGoodAt,
            giveAmt: offerGive,
            getName: botBadAt,
            getAmt: offerGet
        };

        // Update UI
        document.getElementById('inc-give-icon').innerText = (botGoodAt === 'Burgers') ? 'üçî' : 'üçü';
        document.getElementById('inc-give-name').innerText = botGoodAt;
        document.getElementById('inc-give-amt').innerText = offerGive;

        document.getElementById('inc-get-icon').innerText = (botBadAt === 'Burgers') ? 'üçî' : 'üçü';
        document.getElementById('inc-get-name').innerText = botBadAt;
        document.getElementById('inc-get-amt').innerText = offerGet;

        document.getElementById('modal-incoming').classList.remove('hidden');
    }

    function acceptIncoming() {
        // User pays "GetAmt" (what bot wants)
        // User receives "GiveAmt" (what bot gives)
        let payAmt = currentBotOffer.getAmt;
        let payType = currentBotOffer.getName;
        let receiveAmt = currentBotOffer.giveAmt;
        let receiveType = currentBotOffer.giveName;

        // Check funds
        let playerHas = (payType === 'Burgers') ? (productionB + netTradeB) : (productionF + netTradeF);
        
        if(playerHas < payAmt) {
            alert("You cannot accept! Insufficient inventory.");
            return;
        }

        // Execute
        if(payType === 'Burgers') {
            netTradeB -= payAmt;
            netTradeF += receiveAmt;
        } else {
            netTradeF -= payAmt;
            netTradeB += receiveAmt;
        }

        updateEngine();
        closeModal('modal-incoming');
    }

    function declineIncoming() {
        closeModal('modal-incoming');
    }

    // --- UTILS ---
    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
    }

    function submitRound() {
        clearInterval(botInterval);
        let final = document.getElementById('combo-count').innerText;
        document.getElementById('res-score').innerText = final;
        
        // Simple feedback
        let msg = (parseInt(final) > 40) ? "Excellent trading strategy!" : "Tip: Try to trade for items that are hard for you to make.";
        document.getElementById('res-msg').innerText = msg;
        
        document.getElementById('modal-result').classList.remove('hidden');
    }

    function startTimer() {
        let sec = 120;
        let timerInt = setInterval(() => {
            sec--;
            let m = Math.floor(sec/60);
            let s = sec%60;
            document.getElementById('timer').innerText = `0${m}:${s<10?'0'+s:s}`;
            if(sec <= 0) {
                clearInterval(timerInt);
                submitRound();
            }
        }, 1000);
    }
</script>

</body>
</html>
